stages:
  - deploy

deploy:
  stage: deploy
  image: sofia:latest

  only:
    - "staging"

  before_script:
   - eval $(ssh-agent -s)
   - bash -c 'ssh-add <(echo "$SSH_PRIVATE_KEY")'
   - bash -c 'cat <(echo "$SALT_ROSTER") > /etc/salt/roster'
  
  script:
   - rm -fr '/builds/sofia/referenceapplication/.git' && rm -f '/builds/sofia/referenceapplication/.gitlab-ci.yml' && rm -f '/builds/sofia/referenceapplication/.gitignore'
   - rsync -avz --rsync-path="sudo /usr/bin/rsync" -e "ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null" '/builds/sofia/referenceapplication/src/*' root@refapp.hbbtv.org:/srv/www/htdocs/staging/